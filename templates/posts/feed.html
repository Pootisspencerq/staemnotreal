{% extends "base.html" %}
{% load static %}

{% block title %}Стрічка новин{% endblock %}

{% block content %}

<div class="container py-4">
  <h2 class="mb-4 text-light"><i class="bi bi-newspaper"></i> Стрічка новин</h2>

  <form method="post" enctype="multipart/form-data" class="mb-4 p-3 border rounded bg-dark shadow-sm">
    {% csrf_token %}
    <textarea name="text" class="form-control mb-2" rows="3" placeholder="Що у вас нового?"></textarea>
    <input type="file" name="img" class="form-control mb-2">
    <button class="btn btn-primary w-100"><i class="bi bi-send-fill"></i> Опублікувати</button>
  </form>

  <hr class="my-4">

  {% for post in posts %}
    {% include "posts/post_card.html" with post=post %}
  {% empty %}
    <p class="text-center text-muted"><i class="bi bi-hourglass-split"></i> Ще немає постів</p>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ✅ Коментарі (AJAX)
  document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const input = form.querySelector('input[name="text"]');
      const text = input.value.trim();
      if (!text) return;

      const postId = form.dataset.post;
      const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

      const response = await fetch(`/posts/${postId}/comment/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ text })
      });

      if (response.ok) {
        const data = await response.json();
        const commentsBlock = form.closest('.comments-block');
        const noComments = commentsBlock.querySelector('.no-comments');
        if (noComments) noComments.remove();

        const avatarUrl = data.avatar_url || "{% static 'images/default-avatar.png' %}";

        const newComment = document.createElement('div');
        newComment.className = 'd-flex justify-content-between align-items-start mb-2';
        newComment.innerHTML = `
          <p class="mb-1 flex-grow-1 d-flex align-items-center">
            <img src="${avatarUrl}" alt="avatar" class="avatar-comment me-1">
            <b>${data.author}</b>: ${data.text}
          </p>
          <a href="/posts/comment/${data.comment_id}/delete/" class="btn btn-link btn-sm text-danger p-0">
            <i class="bi bi-x-circle"></i>
          </a>
        `;
        commentsBlock.insertBefore(newComment, form);
        input.value = '';

        const postCard = form.closest('.card-body');
        const commentCountEl = postCard.querySelector('.comment-count');
        if (commentCountEl) commentCountEl.textContent = data.comment_count;
      }
    });
  });

  // ✅ Лайки (AJAX)
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.post;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      const response = await fetch(`/posts/${postId}/like/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken }
      });
      if (response.ok) {
        const data = await response.json();
        btn.querySelector('.like-count').textContent = data.like_count;
        btn.classList.toggle('btn-danger', data.liked);
        btn.classList.toggle('btn-outline-danger', !data.liked);
      }
    });
  });
});
</script>

{% endblock %}
