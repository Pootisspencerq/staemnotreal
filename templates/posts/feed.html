{% extends "base.html" %}

{% block title %}Стрічка новин{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4"><i class="bi bi-newspaper"></i> Стрічка новин</h2>

  <!-- Створення поста -->
  <form method="post" enctype="multipart/form-data" 
        class="mb-4 p-3 border rounded bg-light shadow-sm">
    {% csrf_token %}
    <textarea name="text" class="form-control mb-2" rows="3" 
              placeholder="Що у вас нового?"></textarea>
    <input type="file" name="img" class="form-control mb-2">
    <button class="btn btn-primary w-100">
      <i class="bi bi-send-fill"></i> Опублікувати
    </button>
  </form>

  <hr class="my-4">

  <!-- Список постів -->
  {% for post in posts %}
    <div class="card mb-4 shadow-sm border-0 rounded-3">
      <div class="card-body">
        <!-- Автор + дата -->
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong><i class="bi bi-person-circle"></i> {{ post.author.username }}</strong>
            <small class="text-muted">· {{ post.created_at|date:"H:i d.m.Y" }}</small>
          </div>
        </div>

        <!-- Текст -->
        {% if post.text %}
          <p class="mt-3 mb-2">{{ post.text|linebreaksbr }}</p>
        {% endif %}

        <!-- Картинка -->
        {% if post.img %}
          <img src="{{ post.img.url }}" class="img-fluid rounded mb-3 border" alt="Post image">
        {% endif %}

        <!-- Дії -->
        <div class="d-flex align-items-center mb-2">
          <!-- Лайк -->
          <button class="btn btn-sm {% if post.liked_by_user %}btn-danger{% else %}btn-outline-danger{% endif %} like-btn"
                  data-post="{{ post.id }}">
            <i class="bi bi-heart-fill"></i> <span class="like-count">{{ post.like_count }}</span>
          </button>

          <!-- Коментарі -->
          <span class="text-muted ms-3">
            <i class="bi bi-chat-dots"></i>
            <span class="comment-count">{{ post.comment_count }}</span>
          </span>

          <!-- Редагування / Видалення -->
          {% if post.author == user %}
            <a href="{% url 'posts:edit_post' post.id %}" class="btn btn-sm btn-warning ms-3">
              <i class="bi bi-pencil-square"></i>
            </a>
            <form action="{% url 'posts:delete_post' post.id %}" method="post" style="display:inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger ms-1"
                      onclick="return confirm('Видалити пост?')">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          {% endif %}
        </div>

        <!-- Коментарі -->
        <div class="mt-3 border-top pt-2 comments-block" data-post="{{ post.id }}">
          {% for comment in post.comments.all %}
            <div class="d-flex justify-content-between align-items-start mb-2">
              <p class="mb-1 flex-grow-1">
                <b><i class="bi bi-person"></i> {{ comment.author.username }}</b>: {{ comment.text }}
              </p>
              {% if comment.author == user %}
                <form action="{% url 'posts:delete_comment' comment.id %}" method="post" class="ms-2">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-link btn-sm text-danger p-0"
                          onclick="return confirm('Видалити коментар?')">
                    <i class="bi bi-x-circle"></i>
                  </button>
                </form>
              {% endif %}
            </div>
          {% empty %}
            <p class="text-muted mb-1 no-comments"><i class="bi bi-emoji-frown"></i> Немає коментарів</p>
          {% endfor %}

          <!-- Додати коментар -->
          <div class="input-group input-group-sm mt-2">
            <input type="text" class="form-control comment-input" placeholder="Напишіть коментар..." data-post="{{ post.id }}">
            <button class="btn btn-outline-primary add-comment-btn" data-post="{{ post.id }}">
              <i class="bi bi-chat-dots-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="text-center text-muted">
      <i class="bi bi-hourglass-split"></i> Ще немає постів
    </p>
  {% endfor %}
</div>

<!-- JS для AJAX -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  // Лайки
  document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const postId = btn.dataset.post;
      let res = await fetch(`/posts/${postId}/like/`, {
        method: "POST",
        headers: {"X-CSRFToken": csrfToken}
      });
      if (!res.ok) return;
      let data = await res.json();
      btn.querySelector(".like-count").textContent = data.like_count;
      btn.classList.toggle("btn-danger", data.liked);
      btn.classList.toggle("btn-outline-danger", !data.liked);
    });
  });

  // Коментарі
  document.querySelectorAll(".add-comment-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const postId = btn.dataset.post;
      const input = document.querySelector(`.comment-input[data-post="${postId}"]`);
      const text = input.value.trim();
      if (!text) return;

      let res = await fetch(`/posts/${postId}/comment/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `text=${encodeURIComponent(text)}`
      });
      if (!res.ok) return;
      let data = await res.json();

      const block = document.querySelector(`.comments-block[data-post="${postId}"]`);
      // Прибираємо "Немає коментарів", якщо є
      let noComments = block.querySelector(".no-comments");
      if (noComments) noComments.remove();

      const newComment = document.createElement("div");
      newComment.className = "d-flex justify-content-between align-items-start mb-2";
      newComment.innerHTML = `
        <p class="mb-1 flex-grow-1">
          <b><i class="bi bi-person"></i> ${data.author}</b>: ${data.text}
        </p>
      `;
      block.insertBefore(newComment, block.querySelector(".input-group"));
      input.value = "";

      // оновлюємо лічильник
      document.querySelector(`.card-body [data-post="${postId}"]`).closest(".card-body")
        .querySelector(".comment-count").textContent = data.comment_count;
    });
  });
});
</script>
{% endblock %}
