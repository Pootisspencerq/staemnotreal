{% extends "base.html" %}
{% load static %}
{% load static humanize %}

{% block title %}Стрічка новин{% endblock %}

{% block content %}


<div class="container py-4">
  <h2 class="mb-4 text-light"><i class="bi bi-newspaper"></i> Стрічка новин</h2>

  <form method="post" enctype="multipart/form-data" class="mb-4 p-3 border rounded bg-dark shadow-sm">
    {% csrf_token %}
    <textarea name="text" class="form-control mb-2" rows="3" placeholder="Що у вас нового?"></textarea>
    <input type="file" name="file" class="form-control mb-2" accept="*/*">
    <input type="url" name="link" class="form-control mb-2" placeholder="Посилання (необов'язково)">
    <button class="btn btn-primary w-100"><i class="bi bi-send-fill"></i> Опублікувати</button>
  </form>

  {% for post in posts %}
  <div class="post-card">
    <div class="post-votes">
      <button class="vote-btn" data-post="{{ post.id }}" data-action="up">&#9650;</button>
      <div class="vote-count" id="score-{{ post.id }}">{{ post.votes.aggregate_sum_value|default:0 }}</div>
      <button class="vote-btn" data-post="{{ post.id }}" data-action="down">&#9660;</button>
    </div>

    <div class="post-content">
      <div class="post-header">
        {% if post.author.profile.avatar %}
            <img src="{{ post.author.profile.avatar.url }}" class="avatar-post" alt="avatar">
        {% else %}
            <img src="{% static 'images/default-avatar.png' %}" class="avatar-post" alt="avatar">
        {% endif %}

        <div>
          <div class="author">{{ post.author.username }}</div>
          <div class="meta">{{ post.created_at|naturaltime }}</div>
        </div>
      </div>

      {% if post.text %}<p>{{ post.text|linebreaksbr }}</p>{% endif %}
      {% if post.img %}<img src="{{ post.img.url }}" alt="image">{% endif %}

      {% if post.file %}
        {% with post.file.url|lower as url %}
          {% if ".gif" in url %}<img src="{{ post.file.url }}" alt="GIF">{% elif ".mp4" in url or ".webm" in url %}<video controls><source src="{{ post.file.url }}"></video>{% elif ".mp3" in url or ".wav" in url %}<audio controls><source src="{{ post.file.url }}"></audio>{% endif %}
        {% endwith %}
      {% endif %}

      {% if post.link %}<p><a href="{{ post.link }}" target="_blank">{{ post.link }}</a></p>{% endif %}

      <div class="post-actions">
        <button class="like-btn" data-post="{{ post.id }}">&#10084; <span class="like-count">{{ post.like_count }}</span></button>
        <span>{{ post.comment_count }} коментарів</span>
        <div>
          {% if user == post.author %}
          <button class="delete-post-btn" data-post="{{ post.id }}"><i class="bi bi-trash"></i></button>
          {% endif %}
          <button class="repost-btn" data-post="{{ post.id }}"><i class="bi bi-share"></i></button>
        </div>
      </div>

      <div class="comments-block">
        {% for comment in post.comments.all %}
        <div class="comment">
          {% if comment.author.profile.avatar %}
              <img src="{{ comment.author.profile.avatar.url }}" class="avatar-comment" alt="avatar">
          {% else %}
              <img src="{% static 'images/default-avatar.png' %}" class="avatar-comment" alt="avatar">
          {% endif %}

          <div class="comment-text"><b>{{ comment.author.username }}</b>: {{ comment.text }}</div>
          {% if user == comment.author or user.is_staff %}
          <a href="#" class="delete-comment-btn" data-comment="{{ comment.id }}">&#10006;</a>
          {% endif %}
        </div>
        {% empty %}
        <p class="no-comments text-muted">Ще немає коментарів</p>
        {% endfor %}

        <form class="comment-form" data-post="{{ post.id }}">
          {% csrf_token %}
          <input type="text" name="text" placeholder="Напишіть коментар...">
          <button type="submit">&#10148;</button>
        </form>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-center text-muted">Ще немає постів</p>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Comments
  document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const input = form.querySelector('input[name="text"]');
      const text = input.value.trim();
      if (!text) return;
      const postId = form.dataset.post;
      const res = await fetch(`/posts/${postId}/comment/`, {
        method: 'POST', headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ text })
      });
      if (res.ok) {
        const data = await res.json();
        const commentsBlock = form.closest('.comments-block');
        commentsBlock.querySelector('.no-comments')?.remove();
        const newComment = document.createElement('div');
        newComment.className = 'comment';
        newComment.innerHTML = `<img src="${data.avatar_url}" class="avatar-comment" alt="avatar"><div class="comment-text"><b>${data.author}</b>: ${data.text}</div><a href="#" class="delete-comment-btn" data-comment="${data.comment_id}">&#10006;</a>`;
        commentsBlock.insertBefore(newComment, form);
        input.value = '';
        form.closest('.post-content').querySelector('.post-actions span').textContent = `${data.comment_count} коментарів`;
      }
    });
  });

  // Like
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.post;
      const res = await fetch(`/posts/${postId}/like/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
      if (res.ok) {
        const data = await res.json();
        btn.querySelector('.like-count').textContent = data.like_count;
      }
    });
  });

  // Vote
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.post, action = btn.dataset.action;
      const res = await fetch(`/posts/${postId}/vote/${action}/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
      if (res.ok) {
        const data = await res.json();
        document.getElementById(`score-${postId}`).textContent = data.score;
      }
    });
  });

  // Repost
  document.querySelectorAll('.repost-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const postId = btn.dataset.post;
      const res = await fetch(`/posts/${postId}/repost/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
      if (res.ok) alert('Репост успішний!');
    });
  });

  // Delete post
  document.querySelectorAll('.delete-post-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Ви впевнені?')) return;
      const postId = btn.dataset.post;
      const res = await fetch(`/posts/${postId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
      if (res.ok) btn.closest('.post-card').remove();
    });
  });

  // Delete comment
  document.addEventListener('click', async e => {
    if (!e.target.closest('.delete-comment-btn')) return;
    e.preventDefault();
    if (!confirm('Ви впевнені?')) return;
    const btn = e.target.closest('.delete-comment-btn');
    const commentId = btn.dataset.comment;
    const res = await fetch(`/posts/comment/${commentId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrfToken } });
    if (res.ok) btn.closest('.comment').remove();
  });
});
</script>
{% endblock %}
