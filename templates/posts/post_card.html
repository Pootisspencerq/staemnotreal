{% load static %}

<div class="card mb-4 shadow-sm border-0 rounded-3 text-light">
  <div class="card-body">

    <!-- === –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç—É === -->
    <div class="d-flex align-items-center mb-3 post-header">
      <img src="{% if post.author.profile.avatar %}{{ post.author.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
           alt="avatar" class="avatar-post me-2"
           onerror="this.onerror=null;this.src='{% static 'images/default-avatar.png' %}'">
      <div>
        <strong>{{ post.author.username }}</strong><br>
        <small class="text-muted">{{ post.created_at|date:"H:i d.m.Y" }}</small>
      </div>
    </div>

    <!-- === –¢–µ–∫—Å—Ç –ø–æ—Å—Ç—É === -->
    {% if post.text %}
      <p class="mt-2 mb-3">{{ post.text|linebreaksbr }}</p>
    {% endif %}

    <!-- === –§–æ—Ç–æ –ø–æ—Å—Ç—É === -->
    {% if post.img %}
      <img src="{{ post.img.url }}" class="post-image rounded mb-3" alt="Post image">
    {% endif %}

    <!-- === –í—ñ–¥–µ–æ –ø–æ—Å—Ç—É === -->
    {% if post.video %}
      <video controls class="mb-3 w-100">
        <source src="{{ post.video.url }}">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ.
      </video>
    {% endif %}

    <!-- === –§–∞–π–ª –ø–æ—Å—Ç—É === -->
    {% if post.file and not post.img and not post.video %}
      <a href="{{ post.file.url }}" class="file-link mb-3 d-block" download>üìé –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
    {% endif %}

    <!-- === –ü–æ—Å–∏–ª–∞–Ω–Ω—è –ø–æ—Å—Ç—É === -->
    {% if post.link %}
      <p class="mt-2"><a href="{{ post.link }}" target="_blank" class="file-link">üîó {{ post.link }}</a></p>
    {% endif %}

    <!-- === –ö–Ω–æ–ø–∫–∏ === -->
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
      <button class="btn btn-sm {% if post.liked_by_user %}btn-danger{% else %}btn-outline-danger{% endif %} like-btn" data-post="{{ post.id }}">
        <i class="bi bi-heart-fill"></i> <span class="like-count">{{ post.like_count }}</span>
      </button>

      <span class="text-muted">
        <i class="bi bi-chat-dots"></i> <span class="comment-count">{{ post.comment_count }}</span>
      </span>

      {% if post.author == user %}
        <a href="{% url 'posts:edit_post' post.id %}" class="btn btn-sm btn-warning">
          <i class="bi bi-pencil-square"></i>
        </a>
      {% endif %}

      {% if user.is_staff or user.is_superuser %}
        <a href="{% url 'posts:delete_post' post.id %}" class="btn btn-sm btn-outline-danger">
          <i class="bi bi-trash"></i>
        </a>
      {% endif %}

      <form action="{% url 'posts:repost_post' post.id %}" method="post" class="ms-auto">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-info btn-sm">
          <i class="bi bi-arrow-repeat"></i> –†–µ–ø–æ—Å—Ç
        </button>
      </form>
    </div>

    <!-- === –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ === -->
    <div class="mt-3 border-top pt-2 comments-block" data-post="{{ post.id }}">
      {% for comment in post.comments.all %}
        <div class="d-flex justify-content-between align-items-start mb-2">
          <p class="mb-1 flex-grow-1 d-flex align-items-center">
            <img src="{% if comment.author.profile.avatar %}{{ comment.author.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                 alt="avatar" class="avatar-comment me-1"
                 onerror="this.onerror=null;this.src='{% static 'images/default-avatar.png' %}'">
            <b>{{ comment.author.username }}</b>: {{ comment.text }}
          </p>
          {% if comment.author == user or user.is_staff or user.is_superuser %}
            <a href="{% url 'posts:delete_comment' comment.id %}" class="btn btn-link btn-sm text-danger p-0">
              <i class="bi bi-x-circle"></i>
            </a>
          {% endif %}
        </div>
      {% empty %}
        <p class="text-muted mb-1 no-comments">
          <i class="bi bi-emoji-frown"></i> –ù–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
        </p>
      {% endfor %}

      <form method="post" class="input-group input-group-sm mt-2 comment-form" data-post="{{ post.id }}">
        {% csrf_token %}
        <input type="text" name="text" class="form-control comment-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä..." required>
        <button type="submit" class="btn btn-outline-primary"><i class="bi bi-chat-dots-fill"></i></button>
      </form>
    </div>

  </div>
</div>
