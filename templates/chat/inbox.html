{% extends "base.html" %}
{% load static humanize %}

{% block title %}Мої чати{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-light"><i class="bi bi-chat-dots"></i> Мої чати</h2>

    {% if chats %}
        <ul class="list-group list-group-flush bg-dark">
            {% for chat in chats %}
                <li class="list-group-item bg-dark text-light border-secondary mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <a href="{% url 'chat:chat_detail' chat.id %}" class="text-decoration-none text-light fw-bold">
                            {{ chat.name }}
                        </a>
                        <span class="badge bg-secondary">{{ chat.messages.count }}</span>
                    </div>

                    {% with last_message=chat.messages.last %}
                        {% if last_message %}
                            <div class="p-2 bg-secondary bg-opacity-10 rounded">
                                <strong>{{ last_message.author.username }}:</strong>

                                {% if last_message.text %}
                                    <p>{{ last_message.text|linebreaksbr }}</p>
                                {% endif %}

                                {% if last_message.file %}
                                    {% with last_message.file.url|lower as url %}
                                        {% if url.endswith:".png" or url.endswith:".jpg" or url.endswith:".jpeg" or url.endswith:".gif" %}
                                            <img src="{{ last_message.file.url }}" class="img-fluid rounded mt-2" alt="image">
                                        {% elif url.endswith:".mp4" or url.endswith:".webm" or url.endswith:".ogg" %}
                                            <video controls class="w-100 rounded mt-2" preload="metadata">
                                                <source src="{{ last_message.file.url }}" type="video/{{ url|slice:"-3" }}">
                                                Ваш браузер не підтримує відео.
                                            </video>
                                        {% elif url.endswith:".mp3" or url.endswith:".wav" or url.endswith:".ogg" %}
                                            <audio controls class="w-100 mt-2">
                                                <source src="{{ last_message.file.url }}" type="audio/{{ url|slice:"-3" }}">
                                                Ваш браузер не підтримує аудіо.
                                            </audio>
                                        {% else %}
                                            <a href="{{ last_message.file.url }}" target="_blank" class="d-block mt-2 text-info text-decoration-none">
                                                <i class="bi bi-file-earmark-text"></i> {{ last_message.file.name|slice:"-30:" }}
                                            </a>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endwith %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-center mt-5">
            <i class="bi bi-envelope-paper fs-1 text-secondary"></i>
            <p class="mt-3">Поки що немає чатів. Перейдіть у глобальний чат!</p>

            <a href="{% url 'chat:chat_detail' 1 %}" class="btn btn-primary btn-sm mt-2">
                <i class="bi bi-chat-dots"></i> Перейти в глобальний чат
            </a>

            <a href="/" class="btn btn-outline-light btn-sm mt-2">
                <i class="bi bi-house"></i> На головну
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
